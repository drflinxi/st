<https://cloud.tencent.com/developer/article/1929013>
# 倒排索引
又称反向索引，通过value寻找key  

搜索词->文档id 关系映射，通过类似hash算法，快速定位搜索关键词


fieldData/docValue 你可以简单理解为列式存储,索引文件的所有文档的某个字段会被单独存储起来。 对于这块，Lucene 经历了两阶段的发展。第一阶段是fieldData ，查询时从倒排索引反向构成doc-term。

**fieldData/docValue**源于ElasticSearch，搜索时需要用到倒排索引，排序和聚合需要使用正排索引。
|维度|docValue|filedData|
|:--|--|--|
|创建时间|index时创建|使用时动态创建|
|创建位置|磁盘|内存（jvm heap）|
|优点|不占用内存空间|不占用磁盘空间|
|缺点|索引速度稍低|文档很多时，动态创建开销较大，占内存|


**缺点**

+ 数据聚合操作，排序、分组时，内部会遍历提取所有出现在文档集合的排序字段然后再次构建一个最终的排好序的文档集合list，这个步骤的过程全部维持在内存中操作，而且如果排序数据量巨大的话，非常容易就造成solr内存溢出和性能缓慢。 

>基于这个原因，在lucene4.x之后出现了docvalue这个新特性，在构建索引时会对开启docvalues的字段，额外构建一个已经排好序的文档到字段级别的一个列式存储映射，它减轻了在排序和分组时，对内存的依赖，而且大大提升了这个过程的性能，当然它也会耗费的一定的磁盘空间。

+ 数据需要全部加载到内存

+ 第一次构建会很慢

>这两个问题其实会衍生出很多问题：最严重的自然是内存问题。所以lucene后面搞了DocValue，在构建索引的时候就生成这个文件。DocValue可以充分利用操作系统的缓存功能，如果操作系统cache住了，则速度和内存访问是一样的。

**example**
>Doc 1:Java is the best programming language

>Doc 2:PHP is the best programming language

>Doc 3:Javascript is the best programming language

为了创建索引，ES引擎通过分词器将每个文档的内容拆成单独的词（称之为词条，或term），再将这些词条创建成不含重复词条的排序列表，然后列出每个词条出现在哪个文档，结果如下：

| term | Doc1 | Doc2 | Doc3 |
| :---|---|---|---|
|Java|√|||
|is|√|√|√|
|the|√|√|√|
|best|√|√|√|
|programming|√|√|√|
|language|√|√|√|
|PHP||√||
|JavaScript|||√|

这种结构由文档中所有不重复的词的列表构成，对于其中每个词都有至少一个文档与与之关联。这种由属性值来确定记录的位置的结构就是倒排索引，带有倒排索引的文件被称为倒排文件。

其中，几个核心术语需要着重理解：

+ **词条（term）**：索引里面最小的存储和查询单元，对于英文来说是一个词，对于中文来说一般指分词后的一个词。
+ **词典（Term Dictionary）**：也叫字典，是词条的组合。搜索引擎的通常索引单位是单词，单词词典是文档集合中出现过的所有单词构成的字符串集合，单词词典内每条索引项记载单词本身的一些信息以及指向倒排所有的指针。
+ **倒排表（Post list）**：一个文档通常由多个词组成，倒排表记录的是某个词在哪些文档里出现过及出现的位置。每个记录称为一个倒排项（Posting），倒排表记录的不单单是文档编号，还记录了词频等信息。
+ **倒排文件（Inverted File）**：所有单词的倒排列表往往顺序地存储在磁盘的某个文件里，这个文件被称之为倒排文件，倒排文件是存储倒排索引的物理文件。词典和倒排表是 Lucene这种很重要的两种数据结构，是实现快速检索的重要基石。词典和倒排文件是分两部分存储的，词典在内存中而倒排文件存储在磁盘
